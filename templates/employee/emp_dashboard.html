{% extends 'employee/base.html' %}
{% load static %}


{% block custom_css %}
<style>
    table {
      font-family: arial, sans-serif;
      border-collapse: collapse;
      width: 100%;
    }
    
    td, th {
      border: 1px solid #dddddd;
      text-align: left;
      padding: 8px;
    }
    
    tr:nth-child(even) {
      background-color: #dddddd;
    }
    </style>

{% endblock custom_css %}
{% block punch %}
<form  method="POST">
    {% csrf_token %}
  
  {% if mark == True %}
<button type="button" id='punch' name="punchin" value="in" class="btn btn-danger" onclick="out()" >Punchin</button>
{% else %}

<button type="submit" id='punch_out' name="btn" value="out" class="btn btn-danger" onclick="punchout()" >Punchout</button>
{% endif %}


  </form>
  {% endblock punch %}
{% block main_content %}

<h2>Time in-out </h2>
<table>
  <tr>
    <th>S.no</th>
    <th>Date</th>

    <th>Time in</th>
    <th>Time out</th>
    <th>Total working hour</th>
  </tr>
{% for i in punch %}

  <tr>

  <td>{{i.id}}</td>
  <td>{{i.punch_date}}</td>

  <td id="punch_in">{{i.punch_in}}</td>
  <td>{{i.punch_out}}</td>
  <td>{{out}}</td>

  </tr>
  {% endfor %}

</table>
{% endblock main_content %}

{% block custom_js %}
<script>
  
function out(){
  let output = document.getElementById('punch').value
  let today = new Date();
  
        
  date_dic={"time":today,"punchin":output}

  $.ajax({
    url:'http://127.0.0.1:8000/punchin/',
    type: 'POST',
    data:date_dic
  })
  .done(function(response){
  alert('done')
      })
    };

function punchout(){
  
  let output = document.getElementById('punch_out').value
  let today = new Date();
  
        
  date_dic={"time":today,"punchout":output}

  $.ajax({
    url:'http://127.0.0.1:8000/punchout/',
    type: 'POST',
    data:date_dic
  })
  .done(function(response){
 
  
  
  })

}
/*    apiKey: "AIzaSyAa2J8MJTT0ykq6iV_oHWPSPe_9SazCNGE",' \
         '        authDomain: "notification-1a1a5.firebaseapp.com",' \
         '        projectId: "notification-1a1a5",' \
         '        storageBucket: "notification-1a1a5.appspot.com",' \
         '        messagingSenderId: "82591525914",' \
         '        appId: "1:82591525914:web:67e40a1eaaa0d84f6475a3",' \
          */



</script>
<script src="https://www.gstatic.com/firebasejs/7.14.6/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.14.6/firebase-messaging.js"></script>
<script>
    var firebaseConfig = {
        apiKey: "AIzaSyAa2J8MJTT0ykq6iV_oHWPSPe_9SazCNGE",
        authDomain: "notification-1a1a5.firebaseapp.com",
        projectId: "notification-1a1a5",
        storageBucket: "notification-1a1a5.appspot.com",
        messagingSenderId: "82591525914",
        appId: "1:82591525914:web:67e40a1eaaa0d84f6475a3",
    };
    firebase.initializeApp(firebaseConfig);
    const messaging=firebase.messaging();

    function IntitalizeFireBaseMessaging() {
        messaging
            .requestPermission()
            .then(function () {
                console.log("Notification Permission");
                return messaging.getToken();
            })
            .then(function (token) {
                console.log("Token : "+token);
                sendToServer(token);
            })
            .catch(function (reason) {
                console.log(reason);
            });
    }

    messaging.onMessage(function (payload) {
        console.log(payload);
        const notificationOption={
            body:payload.notification.body,
            icon:payload.notification.icon
        };

        if(Notification.permission==="granted"){
            var notification=new Notification(payload.notification.title,notificationOption);

            notification.onclick=function (ev) {
                ev.preventDefault();
                window.open(payload.notification.click_action,'_blank');
                notification.close();
            }
        }

    });
    messaging.onTokenRefresh(function () {
        messaging.getToken()
            .then(function (newtoken) {
                console.log("New Token : "+ newtoken);
                sendToServer(newtoken);
            })
            .catch(function (reason) {
                console.log(reason);
            })
    });

    function sendToServer(token){
         $.ajax({
                url:'http://127.0.0.1:8000/emp_fcm_save/',
                type:'POST',
                data:{token:token},
            })
            .done(function(response){
                if(response=="True"){
                    console.log("Token Save")
                }
                else{
                    console.log("Error in Token Save")
                }
            });
    }
    IntitalizeFireBaseMessaging();
</script>
{% endblock custom_js %}